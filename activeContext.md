# アクティブコンテキスト

<!-- 2025/3/18: プロジェクトのリファクタリングに伴い更新 -->

## 現在の作業焦点

TONゲームプロジェクトは現在、初期実装とリファクタリングのフェーズにあります。既存のドキュメントから、プロジェクトの概要、技術スタック、機能要件、およびアーキテクチャが定義されています。現在の主な焦点は以下の通りです：

1. **プロジェクト構造のリファクタリング**: クライアントサイド（Telegram Mini App）と管理者サイドを完全に分離し、NestJSのベストプラクティスに沿ったディレクトリ構造への移行
2. **認証システムの構築**: Telegram OAuthを使用した認証システムの実装
3. **コアAPIエンドポイントの開発**: クエスト、デイリーログイン、ランキング、ストア、ユーザー、ボット関連のAPIエンドポイントの実装
4. **Unity WebGLゲームの統合**: リズムゲームのUnity WebGL実装と統合

## 最近の変更

1. **データベース構造の実装**: Supabaseデータベースに以下のテーブルを作成
   - users: ユーザー情報を格納するテーブル
   - quests: クエスト情報を格納するテーブル
   - user_quests: ユーザーとクエストの関連を格納するテーブル
   - daily_logins: ユーザーの日次ログイン情報を格納するテーブル
   - transactions: トランザクション情報を格納するテーブル

2. **プロジェクト構造のリファクタリング**: 以下の新しいディレクトリ構造に移行中
   - apps/client: Telegram Mini App（クライアントサイド）
   - apps/admin: 管理者サイド
   - api: バックエンドAPI
   - config: 設定ファイル
   - scripts: スクリプト

## 次のステップ

プロジェクトを進めるための次のステップは以下の通りです：

### 短期的なタスク（1-2週間）

1. **開発環境のセットアップ**:
   - Node.js v20.2.1のインストール確認
   - Next.js 14プロジェクトの初期化
   - Gitリポジトリの設定
   - 必要な依存関係のインストール

2. **プロジェクト構造の実装**:
   - ディレクトリ構造の作成
   - 基本的なルーティングの設定
   - Tailwind CSSの設定
   - Shadcn UIコンポーネントの統合

3. **認証システムの基本実装**:
   - Telegram OAuthの統合
   - Supabase接続の設定
   - 認証フローの実装

### 中期的なタスク（3-4週間）

1. **コアAPIエンドポイントの開発**:
   - クエスト関連APIの実装
   - デイリーログイン機能の実装
   - ランキングシステムの実装
   - ストア機能の実装
   - ユーザー管理APIの実装
   - Telegramボット統合の実装

2. **フロントエンドUIの開発**:
   - ユーザーインターフェースのコンポーネント実装
   - レスポンシブデザインの実装
   - ユーザーフローの実装

3. **Unity WebGLゲームの開発と統合**:
   - リズムゲームの基本機能実装
   - WebGL出力の最適化
   - Next.jsアプリケーションとの統合

### 長期的なタスク（5-8週間）

1. **管理者ダッシュボードの開発**:
   - クエスト管理インターフェースの実装
   - ストアアイテム管理の実装
   - ユーザー進捗管理の実装
   - ランキング設定の実装
   - 分析ダッシュボードの実装

2. **テストと最適化**:
   - ユニットテストの実装
   - 統合テストの実装
   - パフォーマンス最適化
   - セキュリティ強化

3. **デプロイと監視**:
   - CI/CDパイプラインの設定
   - 本番環境へのデプロイ
   - モニタリングとロギングの設定
   - スケーリング戦略の実装

## アクティブな決定と考慮事項

現在、以下の決定と考慮事項がアクティブです：

### 技術的決定

1. **Next.js 14 App Routerの採用**:
   - 決定: フロントエンドとバックエンドの両方にNext.js 14のApp Routerを使用する
   - 状態: 確定
   - 理由: サーバーサイドレンダリングとクライアントサイド機能の組み合わせ、APIとページの統合管理、最新のReactパラダイムへの準拠

2. **認証システムの複数統合**:
   - 決定: Telegram OAuth、Supabase Auth、Clerk Auth、JWTを組み合わせて使用する
   - 状態: 検討中
   - 考慮事項: 複数システムの統合による複雑性と認証フローの整合性の維持

3. **Unity WebGLの採用**:
   - 決定: リズムゲームの実装にUnity WebGLを使用する
   - 状態: 確定
   - 考慮事項: モバイルデバイスでのパフォーマンス最適化と初期ロード時間の管理

### デザイン決定

1. **カラースキーム**:
   - ユーザーUI: メイン色 #3B1E66、背景色 #100C19、テキスト色 #FFFFFF、ボタン色 #3A1F65、アクセント色 #E67E22
   - 管理者UI: 背景色 #181225、テキスト色 #FFFFFF、データアクセント #3B1E66、ボタン色 #3A1F65、警告色 #E74C3C
   - 状態: 確定

2. **フォント選択**:
   - 決定: 'Good Times'フォントをAdobe Typekitを通じて使用
   - 状態: 確定
   - 実装: `<link rel="stylesheet" href="https://use.typekit.net/akn4ocf.css">`

3. **モバイルファーストアプローチ**:
   - 決定: Telegram Mini Appとしての性質を考慮し、モバイルファーストの設計を採用
   - 状態: 確定
   - 考慮事項: タッチフレンドリーな要素、最適化されたナビゲーション、レスポンシブデザイン

### 機能的決定

1. **クエスト管理システム**:
   - 決定: クエストは管理者によって作成・管理され、下書き、レビュー待ち、公開、拒否のステータスを持つ
   - 状態: 確定
   - 考慮事項: モデレーションワークフローの効率化

2. **ポイントシステム**:
   - 決定: ユーザーはクエスト完了とデイリーログインでポイントを獲得し、ゲームプレイとアイテム購入でポイントを消費
   - 状態: 確定
   - 考慮事項: ポイント経済のバランス調整

3. **Telegramボット通知**:
   - 決定: 新しいクエスト、ランキング更新、デイリーログイン報酬、ゲームスコア、ストア購入などの通知を自動送信
   - 状態: 計画中
   - 考慮事項: 通知頻度の最適化とユーザー設定オプション

## 現在の課題とリスク

1. **認証システムの複雑性**:
   - 課題: 複数の認証システム（Telegram OAuth、Supabase Auth、Clerk Auth、JWT）の統合による複雑性
   - 対策: 認証フローの明確な設計と各システムの役割の明確化

2. **Unity WebGLのパフォーマンス**:
   - 課題: モバイルデバイスでのWebGLパフォーマンスと初期ロード時間
   - 対策: アセットの最適化、プログレッシブローディング、代替の軽量モードの検討

3. **APIレート制限**:
   - 課題: Telegram APIやOpenAI APIなどの外部サービスのレート制限
   - 対策: キャッシュ戦略と指数バックオフメカニズムの実装

4. **データ同期と実時間更新**:
   - 課題: ゲームスコア、ランキング更新、ストア取引のリアルタイム同期
   - 対策: 堅牢なAPI設計、WebSocketsの検討、厳格なテスト

5. **セキュリティ脆弱性**:
   - 課題: ロックメカニズムやRLSが正しく設定されていない場合の不正アクセスリスク
   - 対策: 定期的なセキュリティ監査、認証フローの包括的テスト、継続的なモニタリング

これらの課題とリスクに対処しながら、プロジェクトを計画通りに進めていくことが重要です。定期的な進捗確認と調整を行いながら、高品質なTONゲームアプリケーションの開発を目指します。
